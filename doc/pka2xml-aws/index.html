<!DOCTYPE html>
<html><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Reversing Packet Tracer a parte: pka2xml-aws - (&gt;&gt;=) :: mircodz</title><meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="" />

  <script src="https://mircodezorzi.github.io/js/main.js"></script>

  <link rel="preconnect" href="//fonts.gstatic.com">
  <link href="//fonts.googleapis.com/css2?family=Work+Sans&display=swap" rel="stylesheet">
  <link href="//fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/github.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/languages/x86asm.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/languages/cmake.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/languages/lisp.min.js"></script>
  <script charset="utf-8">
    hljs.registerLanguage("emacs-lisp", hljs.getLanguage("lisp").rawDefinition);
  </script>
  <script>hljs.initHighlightingOnLoad();</script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-172736282-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  <link rel="stylesheet" type="text/css" media="screen" href="https://mircodezorzi.github.io/css/main.css" />
  
</head>
<body>
        <div class="content"><header>
  <div class="main">
    <a href="https://mircodezorzi.github.io/">(&gt;&gt;=) :: mircodz</a>
  </div>
  <nav>
    
      <a href="/tags/">tags</a>
    
  </nav>
</header>

<main>
  <article>
    <div class="title">
      <h1 class="title">Reversing Packet Tracer a parte: pka2xml-aws</h1>
      <div class="meta date-posted">Posted on Dec 4, 2020
      
        <div class="meta date-updated">(Updated on Mar 9, 2021)</div>
      
      </div>
    </div>

    <div class="post-tags">
      
      
      <nav class="nav tags">
        <ul class="tags">
          
          <li><a href="/tags/packettracer">packettracer</a></li>
          
        </ul>
      </nav>
      
      
    </div>

    
      
        <div class="hugotoc no-text-decoration">
          <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#backend">Backend</a>
      <ul>
        <li><a href="#installing-the-c-plus-plus-lambda-runtime">Installing the C++ Lambda Runtime</a></li>
        <li><a href="#setting-up-cmake">Setting up CMake</a></li>
        <li><a href="#the-code">The code</a></li>
        <li><a href="#compiling">Compiling</a></li>
      </ul>
    </li>
    <li><a href="#frontend">Frontend</a></li>
  </ul>
</nav>
          <a href="#" class="back-to-top">Back to top</a>
        </div>
      
      <script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('[id^="headline"]');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>

    

    <section class="body">
      <div class="ox-hugo-toc toc">
<div></div>
<div class="heading">Table of Contents</div>
<ul>
<li><a href="#preface">Preface</a></li>
<li><a href="#backend">Backend</a>
<ul>
<li><a href="#installing-the-c-plus-plus-lambda-runtime">Installing the C++ Lambda Runtime</a></li>
<li><a href="#setting-up-cmake">Setting up CMake</a></li>
<li><a href="#the-code">The code</a></li>
<li><a href="#compiling">Compiling</a></li>
</ul>
</li>
<li><a href="#frontend">Frontend</a></li>
</ul>
</div>
<!--endtoc-->
<p>As with the previous post, this is a work in progress, as soon as I can I&rsquo;m going to include all the steps to set-up serverless.</p>
<h2 id="preface">Preface</h2>
<p>After having finally finished writing the tool based on the research from the previous post - which can be found <a href="http://mircodezorzi.github.io/doc/reversing-packet-tracer">here</a> - I decided to distract myself by creating a simple AWS Lambda in C++ that would allow anyone to encode and decode <code>*.pka</code> and <code>*.pkt</code> files.</p>
<iframe style="height:100%;width:100%;border:none;box-shadow: 1px 1px 14px #000;" src="embedded.html"></iframe>
<h2 id="backend">Backend</h2>
<h3 id="installing-the-c-plus-plus-lambda-runtime">Installing the C++ Lambda Runtime</h3>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ git clone https://github.com/awslabs/aws-lambda-cpp.git /tmp/aws-lambda-cpp
$ cd /tmp/aws-lambda-cpp
$ mkdir build
$ cd build
$ cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/pka2xml/lambda-runtime
$ make &amp;&amp; make install
</code></pre></div><h3 id="setting-up-cmake">Setting up CMake</h3>
<div class="highlight"><pre class="chroma"><code class="language-cmake" data-lang="cmake"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">pka2xml</span> <span class="s">LANGUAGES</span> <span class="s">CXX</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span> <span class="s">11</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_PREFIX_PATH</span> <span class="s2">&#34;${PROJECT_SOURCE_DIR}/lambda-runtime;${CMAKE_PREFIX_PATH}&#34;</span><span class="p">)</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">ZLIB</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">aws-lambda-runtime</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">AWSSDK</span> <span class="s">COMPONENTS</span> <span class="s">core</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s2">&#34;main.cpp&#34;</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s">PUBLIC</span> <span class="s">AWS::aws-lambda-runtime</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s">PUBLIC</span> <span class="o">${</span><span class="nv">AWSSDK_LINK_LIBRARIES</span><span class="o">}</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s">PUBLIC</span> <span class="s">re2</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s">PUBLIC</span> <span class="s">ZLIB::ZLIB</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s">PUBLIC</span> <span class="s">cryptopp</span><span class="p">)</span><span class="err">
</span><span class="err"></span><span class="nb">aws_lambda_package_target</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ cmake .. -GNinja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_PREFIX_PATH=../lambda-runtime \
    -DCMAKE_EXPORT_COMPILE_COMMANDS=1 \
    -DBUILD_SHARED_LIBS=ON
</code></pre></div><h3 id="the-code">The code</h3>
<p>First, let&rsquo;s import all the necessary libraries.</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;aws/lambda-runtime/runtime.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;aws/core/utils/json/JsonSerializer.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cryptopp/base64.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;cryptopp/eax.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;cryptopp/filters.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;cryptopp/twofish.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;zlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;re2/re2.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;pka2xml.hpp&#34;</span><span class="cp">
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">retrofit</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">decoded</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>

  <span class="n">CryptoPP</span><span class="o">::</span><span class="n">StringSource</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
    <span class="k">new</span> <span class="n">CryptoPP</span><span class="o">::</span><span class="n">Base64Decoder</span><span class="p">(</span><span class="k">new</span> <span class="n">CryptoPP</span><span class="o">::</span><span class="n">StringSink</span><span class="p">(</span><span class="n">decoded</span><span class="p">)));</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">pka2xml</span><span class="o">::</span><span class="n">decrypt</span><span class="p">(</span><span class="n">decoded</span><span class="p">);</span>
  <span class="c1">// The version number can be found in 5 different spots in the xml, so let&#39;s replace them all.
</span><span class="c1"></span>  <span class="n">re2</span><span class="o">::</span><span class="n">RE2</span><span class="o">::</span><span class="n">GlobalReplace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decrypted</span><span class="p">,</span> <span class="n">R</span><span class="s">&#34;(&lt;VERSION&gt;\d\.\d\.\d\.\d{4}&lt;/VERSION&gt;)&#34;</span><span class="p">,</span> <span class="s">&#34;&lt;VERSION&gt;6.0.1.0000&lt;/VERSION&gt;&#34;</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">pka2xml</span><span class="o">::</span><span class="n">encrypt</span><span class="p">(</span><span class="n">decrypted</span><span class="p">);</span>

  <span class="n">CryptoPP</span><span class="o">::</span><span class="n">StringSource</span><span class="p">(</span><span class="n">encrypted</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
    <span class="k">new</span> <span class="n">CryptoPP</span><span class="o">::</span><span class="n">Base64Encoder</span><span class="p">(</span><span class="k">new</span> <span class="n">CryptoPP</span><span class="o">::</span><span class="n">StringSink</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="nb">false</span><span class="p">));</span>

  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>And at last, our handler function:</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="k">using</span> <span class="k">namespace</span> <span class="n">aws</span><span class="o">::</span><span class="n">lambda_runtime</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Aws</span><span class="o">::</span><span class="n">Utils</span><span class="o">::</span><span class="n">Json</span><span class="p">;</span>

<span class="n">invocation_response</span> <span class="nf">handler</span><span class="p">(</span><span class="n">invocation_request</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">JsonValue</span> <span class="n">json</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">payload</span><span class="p">);</span>

  <span class="c1">// ... error cheking ...
</span><span class="c1"></span>
  <span class="k">auto</span> <span class="n">v</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">View</span><span class="p">();</span>

  <span class="c1">// ... error cheking ...
</span><span class="c1"></span>
  <span class="k">auto</span> <span class="n">file</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;file&#34;</span><span class="p">);</span>
  <span class="c1">// remove url conten-type
</span><span class="c1"></span>  <span class="n">file</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">invocation_response</span><span class="o">::</span><span class="n">success</span><span class="p">(</span><span class="n">retrofit</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="s">&#34;data:text/plain;base64&#34;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">invocation_response</span><span class="o">::</span><span class="n">failure</span><span class="p">(</span><span class="s">&#34;error during the decoding of the file&#34;</span><span class="p">,</span> <span class="s">&#34;InvalidPK&#34;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">run_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><h3 id="compiling">Compiling</h3>
<p>To build the lambda we can run</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ ninja aws-lambda-package-pka2xml
</code></pre></div><p>While to upload it to aws</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">$ aws lambda update-function-code \
    --function-name pka2xml \
    --zip-file fileb://pka2xml.zip \
    --timeout 60
</code></pre></div><h2 id="frontend">Frontend</h2>
<p>Here&rsquo;s a simplified version of one of the functions responsible for the interaction with the AWS Lambda. In this case we are going to encode the <code>.pka</code> file into base64 and send it to the gateway with the directive of retrofitting it for older versions.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">retrofit</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#file&#39;</span><span class="p">).</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://1nlsyfjbcb.execute-api.eu-south-1.amazonaws.com/default/pka2xml&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
        <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
            <span class="nx">file</span><span class="o">:</span> <span class="kr">await</span> <span class="nx">toBase64</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span>
        <span class="p">})</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">b64toBlob</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#file&#39;</span><span class="p">).</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`err: </span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div><p>In other cases, like when we want to encode an <code>.xml</code> into a <code>.pka</code> file we are first going to compress it with zlib and only then encode it to base64 and send it to our backend.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">encode</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">compressed</span> <span class="o">=</span> <span class="nx">pako</span><span class="p">.</span><span class="nx">deflate</span><span class="p">(</span><span class="k">new</span> <span class="nx">TextEncoder</span><span class="p">().</span><span class="nx">encode</span><span class="p">(</span><span class="nx">loadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">)));</span>
  <span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">compressed</span><span class="p">],</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;application/octet-stream&#39;</span> <span class="p">});</span>
  <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://1nlsyfjbcb.execute-api.eu-south-1.amazonaws.com/default/pka2xml&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
      <span class="nx">file</span><span class="o">:</span> <span class="kr">await</span> <span class="nx">toBase64</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span>
      <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;encode&#39;</span><span class="p">,</span>
      <span class="nx">length</span><span class="o">:</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="p">})</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">b64toBlob</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#file&#39;</span><span class="p">).</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.pka&#39;</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
  <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`err: </span><span class="si">${</span><span class="nx">err</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
    </section>
  </article>
</main>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script type="application/javascript">(function() {
     var $window = $(window);
     if ($window.width() >= 1400) { 
         var $toc = $('#TableOfContents');
         if ($toc.length > 0) {
             function onScroll(){
                 var currentScroll = $window.scrollTop();
                 var h = $('.content h1, .content h2, .content h3, .content h4, .content h5, .content h6, .h-feed h2');
                 var id = "";
                 h.each(function (i, e) {
                     e = $(e);
                     if (e.offset().top - 10 <= currentScroll) {
                         id = e.attr('id');
                     }
                 });
                 var current = $toc.find('a.current');
                 if (current.length == 1 && current.eq(0).attr('href') == '#' + id) return true;

                 current.each(function (i, e) {
                     $(e).removeClass('current').siblings('ul').hide();
                 });
                 $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
                     $(e).children('a').addClass('current').siblings('ul').show();
                 });
             }
             $window.on('scroll', onScroll);
             $(document).ready(function() {
                 $toc.find('a').parent('li').find('ul').hide();
                 onScroll();
                 document.getElementsByClassName('hugotoc')[0].style.display = '';
             });}}})();</script>








<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-172736282-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
